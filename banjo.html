<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lemon Banjo</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      emailjs.init({ publicKey: 'WYWVsQcBGt69SrK3u' });
    });

    /* Safe early stub so LemonBanjo is never undefined */
    window.LemonBanjo = window.LemonBanjo || {
      _cfg: { id: '', series: '', model: '', base_price: 0, final_price: 0, selections: [] },
      setConfig(cfg) { this._cfg = { ...this._cfg, ...cfg }; },
      getConfig() { return this._cfg; }
    };
  </script>
</head>

<body>
  <div id="header"></div>

  <section class="product">
    <div class="container">
      <div class="product-grid">
        <!-- GALLERY: main image + thumbs -->
        <div class="product-gallery">
          <div class="thumb-rail" role="list">
            <img data-role="thumb-front"     alt="Front view"       class="thumbnail active" role="listitem" tabindex="0">
            <img data-role="thumb-back"      alt="Back view"        class="thumbnail"        role="listitem" tabindex="0">
            <img data-role="thumb-headstock" alt="Headstock detail" class="thumbnail"        role="listitem" tabindex="0">
            <img data-role="thumb-block"     alt="Block rim detail" class="thumbnail"        role="listitem" tabindex="0">
            <img data-role="thumb-side"      alt="Side view"        class="thumbnail"        role="listitem" tabindex="0">
          </div>

          <div class="main-image-wrapper">
            <img
              alt="Banjo — front"
              class="main-image"
              id="mainImage">
          </div>
        </div>

        <!-- Series + title (right column on desktop, top on mobile) -->
        <div class="product-header-block">
          <p id="seriesText">Lemon Banjos</p>
          <h1 class="product-title" id="productTitle">Loading…</h1>
        </div>

        <!-- Price: right column under header on desktop, below gallery on mobile -->
        <div class="product-price-block">
          <h2><em id="productPrice" aria-live="polite">Loading…</em></h2>
        </div>

        <!-- Remaining details: options, button, description -->
        <div class="product-details">
          <div id="productOptions" aria-describedby="optionsHelp"></div>
          <p id="optionsHelp" class="small mt-neg-8">
            Choose configuration to see updated price.
          </p>

          <button class="button" id="askBtn" type="button">Ask About This Banjo</button>
          <div class="product-description" id="productDescription"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="specs-section">
    <div class="container-wide">
      <h2>Specifications</h2>
      <div id="specsGrid" class="specs-grid" aria-live="polite"></div>
    </div>
  </section>

  <div id="footer"></div>

  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog" aria-label="Image viewer">
    <span class="close" aria-label="Close">&times;</span>
    <span class="prev" aria-label="Previous">&#10094;</span>
    <img id="lightboxImg" alt="">
    <span class="next" aria-label="Next">&#10095;</span>
  </div>

  <!-- Email modal -->
  <div class="lb-modal-backdrop" id="emailModalBackdrop" aria-hidden="true">
    <div class="lb-modal" role="dialog" aria-modal="true" aria-labelledby="emailModalTitle">
      <h3 id="emailModalTitle">Tell me how to reach you</h3>
      <p class="lb-note">I’ll include your selected options and price automatically.</p>
      <form id="emailForm">
        <div class="lb-row">
          <div>
            <label for="custName">Name</label>
            <input id="custName" name="custName" type="text" placeholder="Your name" required />
          </div>
          <div>
            <label for="custEmail">Email</label>
            <input id="custEmail" name="custEmail" type="email" placeholder="you@example.com" required />
          </div>
        </div>
        <div class="lb-row">
          <div>
            <label for="custPhone">Phone</label>
            <input id="custPhone" name="custPhone" type="tel" placeholder="(555) 123-4567" />
          </div>
          <div>
            <label for="custAddress">Address</label>
            <input id="custAddress" name="custAddress" type="text" placeholder="Street address" />
          </div>
        </div>
        <div class="lb-row">
          <div>
            <label for="custCity">City</label>
            <input id="custCity" name="custCity" type="text" placeholder="City" />
          </div>
          <div>
            <label for="custState">State</label>
            <input id="custState" name="custState" type="text" placeholder="State" />
          </div>
        </div>
        <div class="lb-row">
          <div>
            <label for="custZip">ZIP Code</label>
            <input id="custZip" name="custZip" type="text" placeholder="ZIP Code" />
          </div>
        </div>

        <div id="emailStatus" class="lb-note lb-hidden" aria-live="polite"></div>

        <div class="lb-actions">
          <button type="button" class="lb-btn" id="cancelEmail">Cancel</button>
          <button type="submit" class="lb-btn primary" id="sendEmail">Send</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Load header/footer -->
  <script>
    function initHeaderFooter() {
      return Promise.all([
        fetch('header.html').then(r => r.text()).then(h => {
          document.getElementById('header').innerHTML = h;
        }),
        fetch('footer.html').then(r => r.text()).then(f => {
          document.getElementById('footer').innerHTML = f;
        })
      ]).then(() => {
        // this runs AFTER header/footer are in the DOM
        const toggle = document.getElementById('menu-toggle');
        const nav = document.getElementById('main-nav');
        if (toggle && nav) {
          toggle.addEventListener('click', () => {
            const isOpen = nav.classList.toggle('open');
            toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          });
        }
      });
    }

    initHeaderFooter().catch(console.error);
  </script>

  <!-- Routing + image paths from ?key=LEGACY35-LB-00 -->
  <script>
    function getProductKeyFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get('key');
      if (!raw) return null;
      return String(raw).trim().toUpperCase();
    }

    function deriveImageInfo(key) {
      const upper = String(key || '').toUpperCase();
      const parts = upper.split('-');          // ["LEGACY35", "LB", "00"]
      const seriesKey = parts[0] || '';        // "LEGACY35"
      const modelCode = parts.slice(1).join('-') || upper; // "LB-00"
      const modelSlug = modelCode.toLowerCase();           // "lb-00"

      let folder = '35';   // sensible default so something loads

      if (seriesKey.startsWith('LEGACY')) {
        // Take the numeric part after "LEGACY", e.g. "35", "54", "27", "60"
        const num = seriesKey.replace('LEGACY', '').trim();  // "35"
        folder = num || '35';    // e.g. "35" → assets/product_images/35/...
      } else if (seriesKey.startsWith('OLDTIME')) {
        folder = 'oldtime';
      } else if (seriesKey.startsWith('MASTER')) {
        folder = 'master';
      }

      return { folder, modelCode, modelSlug };
    }

    document.addEventListener('DOMContentLoaded', () => {
      const key = getProductKeyFromUrl() || 'LEGACY35-LB-00';

      // Expose key for productInfo.js (fallback) and debugging
      document.body.dataset.model = key;

      const { folder, modelCode, modelSlug } = deriveImageInfo(key);

      // Just set a generic placeholder here;
      // productInfo.js will replace it with the real "Legacy ’35 Series" from the sheet.
      const seriesEl = document.getElementById('seriesText');
      if (seriesEl) {
        seriesEl.textContent = 'Lemon Banjos';
      }

      const base = `assets/product_images/${folder}/${modelSlug}/`;

      const mainImg = document.getElementById('mainImage');
      if (mainImg) {
        mainImg.src = base + 'front.webp';
        mainImg.alt = `${modelCode} banjo — front`;
        mainImg.setAttribute('data-large', base + 'front.webp');
      }

      const thumbMap = {
        'thumb-front':     'front.webp',
        'thumb-back':      'back.webp',
        'thumb-headstock': 'headstockFront.webp',
        'thumb-block':     'block.webp',
        'thumb-side':      'side.webp'
      };

      document.querySelectorAll('.thumb-rail img').forEach(img => {
        const role = img.dataset.role;
        const file = thumbMap[role];
        if (!file) return;
        img.src = base + 'thumbnails/' + file;
        img.setAttribute('data-large', base + file);
      });

      // Seed minimal config for EmailJS in case someone clicks quickly
      if (window.LemonBanjo && typeof window.LemonBanjo.setConfig === 'function') {
        window.LemonBanjo.setConfig({
          id: key,
          series: '',          // productInfo.js will fill this in from the sheet
          model: modelCode
        });
      }
    });
  </script>

  <!-- Email submit logic (uses LemonBanjo.getConfig) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const openBtn  = document.getElementById('askBtn');
      const backdrop = document.getElementById('emailModalBackdrop');
      const cancelBtn = document.getElementById('cancelEmail');
      const form = document.getElementById('emailForm');
      const statusEl = document.getElementById('emailStatus');

      function openModal() {
        backdrop.style.display = 'flex';
        backdrop.setAttribute('aria-hidden', 'false');
        statusEl.classList.add('lb-hidden');
        statusEl.textContent = '';
      }
      function closeModal() {
        backdrop.style.display = 'none';
        backdrop.setAttribute('aria-hidden', 'true');
      }

      openBtn?.addEventListener('click', openModal);
      cancelBtn?.addEventListener('click', closeModal);
      backdrop?.addEventListener('click', e => { if (e.target === backdrop) closeModal(); });

      function setFormDisabled(disabled) {
        const btn = document.getElementById('sendEmail');
        btn.disabled = disabled;
        form.classList.toggle('lb-disabled', disabled);
        form.querySelectorAll('input,button').forEach(el => {
          if (el.id !== 'cancelEmail') el.disabled = disabled;
        });
      }

      function parseMoney(s) {
        const n = parseFloat(String(s || '').replace(/[^0-9.]/g, ''));
        return Number.isFinite(n) ? n : 0;
      }

      function selectionsFromDOM() {
        const out = [];
        document.querySelectorAll('#productOptions .option-block').forEach(block => {
          const group = (block.querySelector('p')?.textContent || block.dataset.group || 'Option').trim();
          const sel = block.querySelector('select');
          if (sel) {
            const opt = sel.options[sel.selectedIndex];
            const label = (opt?.textContent || sel.value).replace(/\s*\(\+.*\)\s*$/, '').trim();
            out.push([group, label]);
            return;
          }
          const chosen = block.querySelector('input:checked');
          if (chosen) {
            const lab = block.querySelector(`label[for="${chosen.id}"]`);
            out.push([group, (lab ? lab.textContent.trim() : chosen.value)]);
          }
        });
        return out;
      }

      form?.addEventListener('submit', async e => {
        e.preventDefault();
        setFormDisabled(true);

        statusEl.innerHTML = '<div class="lb-status"><span class="spinner" aria-hidden="true"></span><span>Sending…</span></div>';
        statusEl.classList.remove('lb-hidden');

        const SERVICE_ID        = 'service_wbxklc2';
        const OWNER_TEMPLATE_ID = 'lemon_info_notice';
        const USER_TEMPLATE_ID  = 'customer_confirmation';

        try {
          const cfg = window.LemonBanjo.getConfig ? window.LemonBanjo.getConfig() : {};
          const pageURL = window.location.href;

          const model  = cfg.model  || (document.body.dataset.model || 'Unknown');
          let   series = (cfg.series || '').trim();

          if (!series) {
            const sTxt = (document.getElementById('seriesText')?.textContent || '').trim();
            const m = sTxt.match(/—\s*(.+)$/);
            if (m) series = m[1].trim();
          }

          const priceEl = document.getElementById('productPrice');

          let base_price = (typeof cfg.base_price === 'number') ? cfg.base_price : NaN;
          if (!Number.isFinite(base_price)) {
            const baseAttr = Number(priceEl?.dataset?.base ?? NaN);
            base_price = Number.isFinite(baseAttr) ? baseAttr : NaN;
          }
          if (!Number.isFinite(base_price)) base_price = 0;

          let final_price = (typeof cfg.final_price === 'number') ? cfg.final_price : NaN;
          if (!Number.isFinite(final_price)) final_price = parseMoney(priceEl?.textContent);
          if (!Number.isFinite(final_price)) final_price = base_price;

          let selections = Array.isArray(cfg.selections) && cfg.selections.length
            ? cfg.selections
            : selectionsFromDOM();

          const selectionsText = selections.length
            ? selections.map(([g,v]) => `${g}: ${v}`).join('\n')
            : '(no selections)';

          const from_name  = document.getElementById('custName').value.trim();
          const from_email = document.getElementById('custEmail').value.trim();
          const phone      = document.getElementById('custPhone').value.trim();
          const address    = document.getElementById('custAddress').value.trim();
          const city       = document.getElementById('custCity').value.trim();
          const state      = document.getElementById('custState').value.trim();
          const zip        = document.getElementById('custZip').value.trim();

          const ownerParams = {
            from_name, from_email, phone, address, city, state, zip,
            model, series,
            base_price: `$${Number(base_price).toLocaleString()}`,
            final_price: `$${Number(final_price).toLocaleString()}`,
            selections: selectionsText,
            page_url: pageURL,
            reply_to: from_email
          };

          const userParams = {
            name: from_name,
            email: from_email,
            model, series,
            base_price: `$${Number(base_price).toLocaleString()}`,
            final_price: `$${Number(final_price).toLocaleString()}`,
            selections: selectionsText,
            page_url: pageURL
          };

          await emailjs.send(SERVICE_ID, OWNER_TEMPLATE_ID, ownerParams);
          await emailjs.send(SERVICE_ID, USER_TEMPLATE_ID, userParams);

          statusEl.innerHTML = '<div class="lb-status success"><span class="check" aria-hidden="true"></span><span>Sent! Check your email for a confirmation.</span></div>';
          setTimeout(() => {
            form.reset();
            setFormDisabled(false);
            closeModal();
          }, 5000);

        } catch (err) {
          statusEl.innerHTML = '<div class="lb-status error">Sorry—could not send just now. Please try again.</div>';
          setFormDisabled(false);
        }
      });
    });
  </script>

  <!-- Dynamic product data + options -->
  <script src="assets/js/productInfo.js"></script>
  <script src="assets/js/galleryLightbox.js" defer></script>
</body>
</html>
