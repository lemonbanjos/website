<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lemon “1935 Series” {{MODEL}}</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      emailjs.init({ publicKey: 'WYWVsQcBGt69SrK3u' });
    });

    /* Safe early stub so LemonBanjo is never undefined */
    window.LemonBanjo = window.LemonBanjo || {
      getConfig() {
        const fallbackModel = document.body?.dataset?.model || 'Unknown';
        return { model: fallbackModel, series: '', base_price: 0, final_price: 0, selections: [] };
      }
    };
  </script>

  <style>
    .lb-modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.55);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .lb-modal {
      background: #111; color: #eee; max-width: 520px; width: 92%;
      border-radius: 12px; padding: 18px; box-shadow: 0 10px 35px rgba(0,0,0,0.5);
    }
    .lb-modal h3 { margin: 0 0 10px; font-size: 1.25rem; }
    .lb-modal form { display:grid; gap: 10px; }
    .lb-row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .lb-modal label { font-size: 0.9rem; display:block; margin-bottom: 4px; }
    .lb-modal input {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #f5f5f5;
    }
    .lb-actions { display:flex; gap: 10px; justify-content: flex-end; margin-top: 6px; }
    .lb-btn { padding: 10px 14px; border: 1px solid #3a3a3a; border-radius: 8px; background:#222; color:#eee; cursor:pointer; }
    .lb-btn.primary { background: #1e7a1e; border-color:#1e7a1e; }
    .lb-note { font-size: 0.85rem; color:#aaa; }
    .lb-hidden { display:none; }

    /* Status styles */
    #emailStatus { margin-top: 4px; }
    .lb-status { display:flex; align-items:center; gap:8px; }
    .lb-status .spinner {
      width:16px; height:16px; border-radius:50%;
      border:2px solid #777; border-top-color:#fff;
      animation: lb-spin 0.9s linear infinite;
    }
    .lb-status.success { color:#9BE59B; }
    .lb-status.error { color:#ffb3b3; }
    .lb-status .check {
      width:16px; height:16px; display:inline-block;
      border-radius:50%; background:#2a7a2a; position:relative;
    }
    .lb-status .check::after {
      content:""; position:absolute; left:4px; top:2px;
      width:6px; height:10px; border-right:2px solid #fff; border-bottom:2px solid #fff; transform:rotate(45deg);
    }
    @keyframes lb-spin { to { transform: rotate(360deg); } }
    .lb-disabled { opacity:0.6; pointer-events:none; }
  </style>
</head>
<body data-model="L3-G">
  <div id="header"></div>

  <section class="product">
    <div class="container">
      <div class="product-grid">
        <div class="product-gallery">
          <div class="thumb-rail" role="list">
            <img data-src="assets/product_images/{{MODELLOWER}}/front.webp" data-large="assets/product_images/{{MODELLOWER}}/front.webp" alt="Front view" class="thumbnail active" role="listitem" tabindex="0">
            <img data-src="assets/product_images/{{MODELLOWER}}/back.webp" data-large="assets/product_images/{{MODELLOWER}}/back.webp" alt="Back view" class="thumbnail" role="listitem" tabindex="0">
            <img data-src="assets/product_images/{{MODELLOWER}}/headstockFront.webp" data-large="assets/product_images/{{MODELLOWER}}/headstockFront.webp" alt="Headstock detail" class="thumbnail" role="listitem" tabindex="0">
            <img data-src="assets/product_images/{{MODELLOWER}}/block.webp" data-large="assets/product_images/{{MODELLOWER}}/block.webp" alt="Block rim detail" class="thumbnail" role="listitem" tabindex="0">
            <img data-src="assets/product_images/{{MODELLOWER}}/side.webp" data-large="assets/product_images/{{MODELLOWER}}/side.webp" alt="Side view" class="thumbnail" role="listitem" tabindex="0">
          </div>
          <div class="main-image-wrapper">
            <img data-src="assets/product_images/{{MODELLOWER}}/front.webp" alt="{{MODEL}} banjo — front" class="main-image" id="mainImage">
          </div>
        </div>

        <div class="product-details">
          <p id="seriesText">Lemon Banjos — # Series</p>
          <h1 class="product-title" id="productTitle">{{MODEL}}</h1>
          <h2><em id="productPrice" aria-live="polite">Loading…</em></h2>

          <div id="productOptions" aria-describedby="optionsHelp"></div>
          <p id="optionsHelp" class="small" style="margin-top:-8px">Choose configuration to see updated price.</p>

          <button class="button" id="askBtn" type="button">Ask About This Banjo</button>
          <div class="product-description" id="productDescription"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="specs-section">
    <div class="container-wide">
      <h2>Specifications</h2>
      <div id="specsGrid" class="specs-grid" aria-live="polite"></div>
    </div>
  </section>

  <div id="footer"></div>

  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog" aria-label="Image viewer">
    <span class="close" aria-label="Close">&times;</span>
    <span class="prev" aria-label="Previous">&#10094;</span>
    <img id="lightboxImg" alt="">
    <span class="next" aria-label="Next">&#10095;</span>
  </div>

  <div class="lb-modal-backdrop" id="emailModalBackdrop" aria-hidden="true">
    <div class="lb-modal" role="dialog" aria-modal="true" aria-labelledby="emailModalTitle">
      <h3 id="emailModalTitle">Tell me how to reach you</h3>
      <p class="lb-note">I’ll include your selected options and price automatically.</p>
      <form id="emailForm">
        <div class="lb-row">
          <div>
            <label for="custName">Name</label>
            <input id="custName" name="custName" type="text" placeholder="Your name" required />
          </div>
          <div>
            <label for="custEmail">Email</label>
            <input id="custEmail" name="custEmail" type="email" placeholder="you@example.com" required />
          </div>
        </div>
        <div class="lb-row">
          <div>
            <label for="custPhone">Phone</label>
            <input id="custPhone" name="custPhone" type="tel" placeholder="(555) 123-4567" />
          </div>
          <div>
            <label for="custAddress">Address</label>
            <input id="custAddress" name="custAddress" type="text" placeholder="Street address" />
          </div>
        </div>
        <div class="lb-row">
          <div>
            <label for="custCity">City</label>
            <input id="custCity" name="custCity" type="text" placeholder="City" />
          </div>
          <div>
            <label for="custState">State</label>
            <input id="custState" name="custState" type="text" placeholder="State" />
          </div>
        </div>
        <div class="lb-row">
          <div>
            <label for="custZip">ZIP Code</label>
            <input id="custZip" name="custZip" type="text" placeholder="ZIP Code" />
          </div>
        </div>

        <div id="emailStatus" class="lb-note lb-hidden" aria-live="polite"></div>

        <div class="lb-actions">
          <button type="button" class="lb-btn" id="cancelEmail">Cancel</button>
          <button type="submit" class="lb-btn primary" id="sendEmail">Send</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    Promise.all([
      fetch('header.html').then(r => r.text()).then(h => { document.getElementById('header').innerHTML = h; }),
      fetch('footer.html').then(r => r.text()).then(f => { document.getElementById('footer').innerHTML = f; })
    ]).catch(console.error);
  </script>

  <!-- Model + image placeholders -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const model = document.body.dataset.model;
      if (!model) return;
      const modelLower = model.toLowerCase();

      document.title = `Lemon “1935 Series” ${model}`;
      const titleEl = document.getElementById('productTitle');
      if (titleEl) titleEl.textContent = model;

      const swapTokens = (s) => s.replace(/\{\{MODELLOWER\}\}/gi, modelLower).replace(/\{\{MODEL\}\}/g, model);

      document.querySelectorAll('.product-gallery img').forEach(img => {
        const ds = img.getAttribute('data-src');
        const dl = img.getAttribute('data-large');
        if (ds) img.setAttribute('src', swapTokens(ds));
        if (dl) img.setAttribute('data-large', swapTokens(dl));
        if (img.alt) img.alt = img.alt.replace(/\{\{MODEL\}\}/g, model);
      });

      const mainImg = document.getElementById('mainImage');
      if (mainImg) {
        const ds = mainImg.getAttribute('data-src');
        if (ds) mainImg.setAttribute('src', swapTokens(ds));
        mainImg.setAttribute('alt', `${model} banjo — front`);
      }
    });
  </script>

  <!-- Email submit: owner + user confirmation; 5s linger -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const openBtn = document.getElementById('askBtn');
      const backdrop = document.getElementById('emailModalBackdrop');
      const cancelBtn = document.getElementById('cancelEmail');
      const form = document.getElementById('emailForm');
      const statusEl = document.getElementById('emailStatus');

      function openModal() {
        backdrop.style.display = 'flex';
        backdrop.setAttribute('aria-hidden', 'false');
        statusEl.classList.add('lb-hidden');
        statusEl.textContent = '';
      }
      function closeModal() {
        backdrop.style.display = 'none';
        backdrop.setAttribute('aria-hidden', 'true');
      }

      openBtn?.addEventListener('click', openModal);
      cancelBtn?.addEventListener('click', closeModal);
      backdrop?.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });

      function setFormDisabled(disabled) {
        const btn = document.getElementById('sendEmail');
        btn.disabled = disabled;
        form.classList.toggle('lb-disabled', disabled);
        form.querySelectorAll('input,button').forEach(el => {
          if (el.id !== 'cancelEmail') el.disabled = disabled;
        });
      }

      function parseMoney(s) {
        const n = parseFloat(String(s || '').replace(/[^0-9.]/g, ''));
        return Number.isFinite(n) ? n : 0;
      }
      function selectionsFromDOM() {
        const out = [];
        document.querySelectorAll('#productOptions .option-block').forEach(block => {
          const group = (block.querySelector('p')?.textContent || block.dataset.group || 'Option').trim();
          const sel = block.querySelector('select');
          if (sel) {
            const opt = sel.options[sel.selectedIndex];
            const label = (opt?.textContent || sel.value).replace(/\s*\(\+.*\)\s*$/, '').trim();
            out.push([group, label]);
            return;
          }
          const chosen = block.querySelector('input:checked');
          if (chosen) {
            const lab = block.querySelector(`label[for="${chosen.id}"]`);
            out.push([group, (lab ? lab.textContent.trim() : chosen.value)]);
          }
        });
        return out;
      }

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        setFormDisabled(true);

        statusEl.innerHTML = '<div class="lb-status"><span class="spinner" aria-hidden="true"></span><span>Sending…</span></div>';
        statusEl.classList.remove('lb-hidden');

        const SERVICE_ID = 'service_wbxklc2';
        const OWNER_TEMPLATE_ID = 'lemon_info_notice';
        const USER_TEMPLATE_ID  = 'customer_confirmation';

        try {
          const cfg = (window.LemonBanjo && window.LemonBanjo.getConfig) ? window.LemonBanjo.getConfig() : null;

          const pageURL = window.location.href;
          const model = cfg?.model || (document.body.dataset.model || 'Unknown');

          let series = (cfg?.series || '').trim();
          if (!series) {
            const sTxt = (document.getElementById('seriesText')?.textContent || '').trim();
            const m = sTxt.match(/—\s*(.+)$/);
            if (m) series = m[1].trim();
          }

          const priceEl = document.getElementById('productPrice');
          let base_price = (typeof cfg?.base_price === 'number') ? cfg.base_price : NaN;
          if (!Number.isFinite(base_price)) {
            const baseAttr = Number(priceEl?.dataset?.base ?? NaN);
            base_price = Number.isFinite(baseAttr) ? baseAttr : NaN;
          }
          if (!Number.isFinite(base_price)) base_price = 0;

          let final_price = (typeof cfg?.final_price === 'number') ? cfg.final_price : NaN;
          if (!Number.isFinite(final_price)) final_price = parseMoney(priceEl?.textContent);
          if (!Number.isFinite(final_price)) final_price = base_price;

          let selections = Array.isArray(cfg?.selections) && cfg.selections.length ? cfg.selections : selectionsFromDOM();
          const selectionsText = selections.length
            ? selections.map(([g,v]) => `${g}: ${v}`).join('\n')
            : '(no selections)';

          const from_name  = document.getElementById('custName').value.trim();
          const from_email = document.getElementById('custEmail').value.trim();
          const phone      = document.getElementById('custPhone').value.trim();
          const address    = document.getElementById('custAddress').value.trim();
          const city       = document.getElementById('custCity').value.trim();
          const state      = document.getElementById('custState').value.trim();
          const zip        = document.getElementById('custZip').value.trim();

          const ownerParams = {
            from_name, from_email, phone, address, city, state, zip,
            model, series,
            base_price: `$${Number(base_price).toLocaleString()}`,
            final_price: `$${Number(final_price).toLocaleString()}`,
            selections: selectionsText,
            page_url: pageURL,
            reply_to: from_email
          };

          const userParams = {
            name: from_name,
            email: from_email,
            model, series,
            base_price: `$${Number(base_price).toLocaleString()}`,
            final_price: `$${Number(final_price).toLocaleString()}`,
            selections: selectionsText,
            page_url: pageURL,
          };

          await emailjs.send(SERVICE_ID, OWNER_TEMPLATE_ID, ownerParams);
          await emailjs.send(SERVICE_ID, USER_TEMPLATE_ID, userParams);

          statusEl.innerHTML = '<div class="lb-status success"><span class="check" aria-hidden="true"></span><span>Sent! Check your email for a confirmation.</span></div>';
          setTimeout(() => {
            form.reset();
            setFormDisabled(false);
            closeModal();
          }, 5000);

        } catch (err) {
          statusEl.innerHTML = '<div class="lb-status error">Sorry—could not send just now. Please try again.</div>';
          setFormDisabled(false);
        }
      });
    });
  </script>

  <script src="assets/js/productInfo.js"></script>
  <script src="assets/js/galleryLightbox.js" defer></script>
</body>
</html>
